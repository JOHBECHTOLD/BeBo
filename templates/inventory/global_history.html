{% extends 'base.html' %}
{% load inventory_extras %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0 text-bebo"><i class="bi bi-clock-history"></i> {{ view_title|default:"Aktivitäten-Protokoll" }}</h1>
    
    <!-- Gruppe für die Buttons -->
    <div>
        <!-- Button zum Zürücksetzen wird nur angezeigt, wenn es URL-Parameter gibt -->
        {% if request.GET %}
            <a href="{% url 'global_history' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-lg"></i> Filter zurücksetzen
            </a>
        {% endif %}
        <!-- Button zum Zurück gehen -->
        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary ms-2">Zurück</a>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead>
                  <tr>
                        <th>
                            <!-- Wir bestimmen die nächste Richtung VOR dem Aufruf des Tags -->
                            {% if current_sort == 'wann' %}
                                {% url_replace sort='wann' dir=next_sort_dir as sort_url %}
                            {% else %}
                                {% url_replace sort='wann' dir='asc' as sort_url %}
                            {% endif %}
                            <a href="?{{ sort_url }}" class="text-bebo text-decoration-none">
                                Wann
                                {% if current_sort == 'wann' %}<i class="bi bi-arrow-{% if current_dir == 'asc' %}up{% else %}down{% endif %}"></i>{% endif %}
                            </a>
                        </th>
                        <th>
                            {% if current_sort == 'wer' %}
                                {% url_replace sort='wer' dir=next_sort_dir as sort_url %}
                            {% else %}
                                {% url_replace sort='wer' dir='asc' as sort_url %}
                            {% endif %}
                            <a href="?{{ sort_url }}" class="text-bebo text-decoration-none">
                                Wer
                                {% if current_sort == 'wer' %}<i class="bi bi-arrow-{% if current_dir == 'asc' %}up{% else %}down{% endif %}"></i>{% endif %}
                            </a>
                        </th>
                        <th>
                            {% if current_sort == 'aktion' %}
                                {% url_replace sort='aktion' dir=next_sort_dir as sort_url %}
                            {% else %}
                                {% url_replace sort='aktion' dir='asc' as sort_url %}
                            {% endif %}
                            <a href="?{{ sort_url }}" class="text-bebo text-decoration-none">
                                Aktion
                                {% if current_sort == 'aktion' %}<i class="bi bi-arrow-{% if current_dir == 'asc' %}up{% else %}down{% endif %}"></i>{% endif %}
                            </a>
                        </th>
                        <th>
                            {% if current_sort == 'box' %}
                                {% url_replace sort='box' dir=next_sort_dir as sort_url %}
                            {% else %}
                                {% url_replace sort='box' dir='asc' as sort_url %}
                            {% endif %}
                            <a href="?{{ sort_url }}" class="text-bebo text-decoration-none">
                                Box
                                {% if current_sort == 'box' %}<i class="bi bi-arrow-{% if current_dir == 'asc' %}up{% else %}down{% endif %}"></i>{% endif %}
                            </a>
                        </th>
                        <th>
                            {% if current_sort == 'lagerort' %}
                                {% url_replace sort='lagerort' dir=next_sort_dir as sort_url %}
                            {% else %}
                                {% url_replace sort='lagerort' dir='asc' as sort_url %}
                            {% endif %}
                            <a href="?{{ sort_url }}" class="text-bebo text-decoration-none">
                                Lagerort
                                {% if current_sort == 'lagerort' %}<i class="bi bi-arrow-{% if current_dir == 'asc' %}up{% else %}down{% endif %}"></i>{% endif %}
                            </a>
                        </th>
                        <th>
                            {% if current_sort == 'status' %}
                                {% url_replace sort='status' dir=next_sort_dir as sort_url %}
                            {% else %}
                                {% url_replace sort='status' dir='asc' as sort_url %}
                            {% endif %}
                            <a href="?{{ sort_url }}" class="text-bebo text-decoration-none">
                                Status
                                {% if current_sort == 'status' %}<i class="bi bi-arrow-{% if current_dir == 'asc' %}up{% else %}down{% endif %}"></i>{% endif %}
                            </a>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for h in page_obj %}
                    <tr>
                        <!-- Wann -->
                        <td class="text-nowrap">{{ h.history_date|date:"d.m.Y H:i" }}</td>
                        
                        <!-- Wer -->
                        <td>
                            {% if h.history_user %}
                                <span class="badge user-badge"><i class="bi bi-person"></i> {{ h.history_user.username }}</span>
                            {% else %}
                                <span class="text-muted small">System</span>
                            {% endif %}
                        </td>
                        
                        <!-- Aktion (Übersetzung der Codes) -->
                        <td>
                            {% if h.history_type == '+' %}
                                <span class="badge bg-success me-1">Erstellt</span>

                            {% elif h.history_type == '-' %}
                                <span class="badge bg-danger me-1">Gelöscht</span>

                            {% else %}
                                <span class="badge bg-bebo me-1">Geändert</span>
                            {% endif %}

                            {% if h.history_change_reason %}
                                <!-- Konkreter Text wie "Status geändert …" oder "Bild gelöscht …" -->
                                <div class="small mt-1 text-break">
                                    {{ h.history_change_reason }}
                                </div>
                            {% elif h.history_type == '~' %}
                                <!-- Fallback, falls kein Reason gesetzt ist -->
                                <div class="small mt-1 text-muted">
                                    Details nicht verfügbar
                                </div>
                            {% endif %}
                        </td>
                        
                        <!-- Box Label (Link nur wenn nicht gelöscht) -->
                        <td class="font-monospace">
                            {% if h.history_type == '-' %}
                                 <span class="text-decoration-line-through text-muted">{{ h.label|format_barcode }}</span>
                            {% else %}
                                <a href="{% url 'box_detail' h.label %}"
                                    class="text-bebo text-decoration-none fw-bold">
                                        {{ h.label|format_barcode }}
                                </a>
                            {% endif %}
                        </td>
                        
                        <!-- Ort -->
                        <td>{{ h.location.name }}</td>
                        
                        <!-- Status -->
                        <td>
                            {% if h.status == 'STORED' %}Gelagert
                            {% elif h.status == 'ACCESS' %}Im Zugriff
                            {% else %}{{ h.get_status_display }}
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-4 text-muted">Keine Aktivitäten gefunden.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- in global_history.html -->
    {% if page_obj.has_other_pages %}
    <div class="card-footer">
        <nav>
            <ul class="pagination justify-content-center mb-0">
                {% if page_obj.has_previous %}
                    <li class="page-item"><a class="page-link" href="?{% url_replace page=page_obj.previous_page_number %}">Zurück</a></li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">Zurück</span></li>
                {% endif %}

                <li class="page-item active"><span class="page-link">{{ page_obj.number }} von {{ page_obj.paginator.num_pages }}</span></li>

                {% if page_obj.has_next %}
                    <li class="page-item"><a class="page-link" href="?{% url_replace page=page_obj.next_page_number %}">Weiter</a></li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">Weiter</span></li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>
{% endblock %}