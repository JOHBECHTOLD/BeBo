{% extends 'base.html' %}
{% load inventory_extras %}

{% block content %}
<!-- Header Bereich -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a href="{% url 'dashboard' %}" class="text-decoration-none text-muted mb-1 d-block">
            <i class="bi bi-arrow-left"></i> Zurück zur Übersicht
        </a>
        <h1 class="h2 text-bebo font-monospace">{{ box.label|format_barcode }}</h1>
    </div>
    <!-- ÄNDERUNG: Bearbeiten-Button nur für User/Master Feature (1.6.0)-->
    {% if perms.inventory.change_box %}
    <div>
        <a href="{% url 'box_edit' box.label %}" class="btn btn-bebo">
            <i class="bi bi-pencil"></i> Bearbeiten
        </a>
    </div>
    {% endif %}
</div>

<div class="row g-4">
    <!-- Linke Spalte: Hauptinfos -->
    <div class="col-md-8">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-transparent border-bottom-0 pt-3">
                <ul class="nav nav-tabs card-header-tabs" id="boxTab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active text-bebo" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button">Info</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link text-bebo" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button">Verlauf</button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="boxTabContent">                 
                    <!-- TAB 1: Infos -->
                    <div class="tab-pane fade show active" id="info">
                        <!-- ÄNDERUNG: Klick auf Lagerort filtert Dashboard (Feature 1.6.0) -->
                        <h5 class="card-title mt-2">
                            <a href="{% url 'dashboard' %}?location={{ box.location.id }}" class="text-bebo text-decoration-none">
                                {{ box.location.name }} <i class="bi bi-filter small"></i>
                            </a>
                        </h5>
                        
                        <div class="mb-3">
                            <!-- NEU: Status-Badge verlinkt nun zum gefilterten Dashboard -->
                            <a href="{% url 'dashboard' %}?status={{ box.status }}" class="text-decoration-none">
                                {% if box.status == 'STORED' %}
                                    <span class="badge bg-success"><i class="bi bi-check-circle"></i> Gelagert</span>
                                {% elif box.status == 'ACCESS' %}
                                    <span class="badge bg-success"><i class="bi bi-hand-index-thumb"></i> Im Zugriff</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">{{ box.get_status_display }}</span>
                                {% endif %}
                            </a>
    
                            <!-- Kategorien (hast du wahrscheinlich schon drin) -->
                            {% for cat in box.categories.all %}
                                <a href="{% url 'dashboard' %}?category={{ cat.id }}" class="badge text-decoration-none" style="background-color: {{ cat.color }}">
                                    {{ cat.name }}
                                </a>
                            {% endfor %}
                        </div>

                        <p class="card-text lead fs-6">
                            {{ box.description|default:"Keine Beschreibung hinterlegt."|linebreaks }}
                        </p>
                    </div>

                    <!-- TAB 2: Verlauf (Audit Log) -->
                    <div class="tab-pane fade" id="history">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Wann</th>
                                        <th>Wer</th>
                                        <th>Aktion / Details</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in history_data %}
                                    <tr>
                                        <!-- Wann -->
                                        <td class="text-nowrap align-top" style="width: 150px;">
                                            <small>{{ item.record.history_date|date:"d.m.Y H:i" }}</small>
                                        </td>
                                        
                                        <!-- Wer -->
                                        <td style="width: 100px;" class="align-top">
                                            <span class="badge user-badge">
                                                {{ item.record.history_user|default:"System" }}
                                            </span>
                                        </td>
                                        
                                        <!-- Was / Details -->
                                        <td>
                                            {% if item.record.history_type == '+' %}
                                                <span class="badge bg-success">Erstellt</span>
                                            
                                            {% elif item.record.history_type == '-' %}
                                                <span class="badge bg-danger">Gelöscht</span>
                                            
                                            {% else %}
                                                <span class="badge bg-primary mb-1">Geändert</span>
                                                
                                                <!-- Die Details als kleine Liste -->
                                                {% if item.changes %}
                                                    <ul class="list-unstyled mb-0 small border-start border-3 ps-2 mt-1">
                                                    {% for change in item.changes %}
                                                        <li>
                                                            <strong>{{ change.field }}:</strong> 
                                                            <span class="text-muted text-decoration-line-through">{{ change.old }}</span> 
                                                            &rarr; 
                                                            <span class="fw-bold">{{ change.new }}</span>
                                                        </li>
                                                    {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <div class="small text-muted fst-italic">(Keine Felder geändert)</div>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="3">Keine Änderungen protokolliert.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rechte Spalte: Bilder (Platzhalter Logik) -->
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-header bg-transparent fw-bold text-bebo">
                Bilder
            </div>
                        <div class="card-body text-center p-3">
                {% if box.images.exists %}
                    <!-- Karussell für Bilder (Bootstrap Carousel) -->
                    <div id="boxImagesCarousel" class="carousel slide mb-3" data-bs-ride="carousel">
                        <div class="carousel-inner rounded shadow-sm">
                            {% for img in box.images.all %}
                            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                <!-- NEU: Link für Lightbox (Vollbild) -->
                                <!-- data-fslightbox="gallery" gruppiert alle Bilder zu einer Diashow -->
                                <a data-fslightbox="gallery" href="{{ img.image.url }}">
                                    <!-- cursor: pointer zeigt an, dass man klicken kann -->
                                    <img src="{{ img.image.url }}" class="d-block w-100" style="object-fit: cover; height: 300px; cursor: pointer;" alt="Box Inhalt">
                                </a>
                                
                                <div class="carousel-caption d-none d-md-block p-1 bg-dark bg-opacity-50 rounded-bottom">
                                    <small>{{ img.uploaded_at|date:"d.m.Y" }} (Klicken für Vollbild)</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        {% if box.images.count > 1 %}
                        <button class="carousel-control-prev" type="button" data-bs-target="#boxImagesCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Zurück</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#boxImagesCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Weiter</span>
                        </button>
                        {% endif %}
                    </div>
                {% else %}
                    <!-- Wenn kein Bild da ist -->
                    <div class="py-5 bg-light rounded mb-3 border border-dashed">
                        <i class="bi bi-camera fs-1 text-muted opacity-25"></i>
                        <p class="text-muted small mt-2 mb-0">Keine Bilder vorhanden.</p>
                    </div>
                {% endif %}
                
                <!-- Der Upload Button führt jetzt direkt zum Bearbeiten-Modus -->
                <!-- 4. ÄNDERUNG: Foto-Upload Button nur für User/Master -->
                {% if perms.inventory.change_box %}
                <a href="{% url 'box_edit' box.label %}" class="btn btn-sm btn-outline-secondary w-100">
                    <i class="bi bi-upload"></i> Foto hochladen / Bearbeiten
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}